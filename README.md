ModernEx Inventory Microservice
=================================

Lightweight Node.js + Express microservice using SQLite to model quarry/block/slab flows (QBID → Block → SLID → Dispatch).

Also includes derived-product families created from slabs (Tiles, Cobbles, Monuments, Pavers) and a browser UI served under `/ui/`.

Quick start
-----------

Requirements: Node v16+ and npm

Run locally:

```bash
cd uiux/modernex/inventory-service
npm install

# create/update DB schema
npm run migrate

# optional: seed some demo data
npm run seed

# Recommended: start the dev instance via helper (DB=dev, port 4002)
./scripts/manage-servers.sh start dev

# UI: http://localhost:4002/ui/
# API: http://localhost:4002/
```

Access from phone / other device (same Wi‑Fi)
--------------------------------------------

If your phone (or another laptop) is on the same network as your Mac, you can open the UI using your Mac’s LAN IP + the service port.

1) Find your Mac IP (Wi‑Fi usually `en0`):

```bash
ipconfig getifaddr en0

# If that prints nothing, try:
ipconfig getifaddr en1
```

2) Open in your phone browser:

- Dev helper (`./scripts/manage-servers.sh start dev`): `http://<MAC_IP>:4002/ui/`
- Test helper (`./scripts/manage-servers.sh start test`): `http://<MAC_IP>:4001/ui/`

Troubleshooting:

- Ensure both devices are on the same Wi‑Fi and not an isolated “Guest” network.
- If macOS Firewall is enabled, allow incoming connections for `node`.
- If you can open `http://localhost:<PORT>/ui/` on the Mac but not from phone, confirm the server is listening on all interfaces (host `0.0.0.0`, not `127.0.0.1`).

Alternative (no helper):

```bash
# Starts on PORT=4001 by default
npm start

# UI: http://localhost:4001/ui/
# API: http://localhost:4001/
```

If you need realistic demo data including suppliers/QBIDs/blocks/slabs/tiles/events/dispatches, run:

```bash
DB_NAME=dev node scripts/seed-dev-test-data.js --count 1
```

API examples
------------

Assume:

```bash
BASE=http://localhost:4002
```

Create a QBID (Block master record):

```bash
curl -s -X POST $BASE/qbids -H 'Content-Type: application/json' \
	-d '{"supplier":"Acme","quarry":"Q1","weight_kg":12000,"size_mm":"2000x1200x1500","grade":"A","received_date":"2025-12-01"}' | jq
```

Note: if you omit `weight_kg` and provide both `size_mm` (LxWxH in mm) and `stone_type` (e.g. `granite`), the service will auto-calculate `weight_kg` using an approximate density.

Split a block (create children):

```bash
# New-style QBID example (auto-generated by POST /qbids): qbid-parm-00001
curl -s -X POST $BASE/blocks/qbid-parm-00001/split -H 'Content-Type: application/json' -d '{}' | jq

# Legacy seeded QBID example still works (from npm run seed): QBID-DEMO1
# curl -s -X POST http://localhost:4001/blocks/QBID-DEMO1/split -H 'Content-Type: application/json' -d '{}' | jq
```

Create a SLID from a block:

```bash
# New-style auto-generated block example: BLK-PARM-00001-001
curl -s -X POST $BASE/slabs -H 'Content-Type: application/json' \
	-d '{"block_id":"BLK-PARM-00001-001","thickness_mm":20,"machine_id":"GANG1","slabs_yield":20}' | jq
```

Log a finishing event:

```bash
curl -s -X POST $BASE/slabs/SLID-XXXX/finish -H 'Content-Type: application/json' \
	-d '{"action":"POLISHED","payload":{"line":"P1","operator":"joe"}}' | jq
```

Dispatch a slab:

```bash
curl -s -X POST $BASE/dispatch -H 'Content-Type: application/json' \
	-d '{"slid":"SLID-XXXX","customer":"ACME Inc","bundle_no":"BND-1","container_no":"C123"}' | jq
```

IDs and derived families
-----------------------

Deterministic ID formats (new-style):

- **QBID**: `qbid-<materialShortLower>-00001` (sequence is per material short)
- **Block**: `BLK-<MATSHORT-SEQ>-001`
- **SLID**: `SLID-<MATSHORT-SEQ>-BBB-SSS`

Derived product families:

- Tiles (`TILE-*`)
- Cobbles (`COB-*`)
- Monuments (`MON-*`)
- Pavers (`PAV-*`)

Rules enforced by the API:

- Creating derived items from a `slid` requires the slab to have `stone_type` set.
- `slid` is exclusive across derived families (a single slab cannot be used for multiple derived families).
- If a slab is reserved via `stone_type` (e.g. `stone_type='pavers'`), other derived families are denied for that `slid`.

Notes and next steps
--------------------
- This is a minimal local service intended for prototyping and UI wiring.
- Consider adding authentication, validation, and proper error responses for production.
- To integrate with Zoho, add adapters that map QBID/SLID events to Zoho Creator/Inventory/Books APIs.

Database migrations (dev/test/prod)
---------------------------------
Migrations are idempotent and run safely via `db.js`. Recommended commands:

```bash
# Migrate the default development DB (dev.db)
npm run migrate

# Migrate an explicit DB by name (creates <name>.db in the project folder)
DB_NAME=test_ui npm run migrate

# Migrate the production DB file (example)
DB_NAME=prod npm run migrate
```

CI recommendation: set `DB_NAME=test_ui` in your CI environment and run `npm run migrate` before running tests to ensure the test DB schema is up-to-date.

Developer commands (common)
---------------------------
Quick reference of useful commands for development, testing and deployment.

Install dependencies

```bash
npm install
```

Run migrations (development DB)

```bash
npm run migrate
# or explicitly by name (creates <name>.db in project folder)
DB_NAME=test_ui npm run migrate
DB_NAME=prod npm run migrate
```

Seed sample data (after migrating)

```bash
npm run seed

# richer dev/test data via API (includes suppliers)
DB_NAME=dev node scripts/seed-dev-test-data.js --count 1
```

Wipe data (destructive)

```bash
# wipe currently-selected DB (defaults to dev.db)
npm run wipe

# wipe dev.db + test_ui.db
npm run wipe:all
```

Export / import full DB
----------------------

Two supported formats:

- **DB snapshot** (`.db`, default): exact copy of the SQLite file (schema + data). Fastest and most reliable.
- **SQL dump** (`.sql`): portable text dump (schema + INSERTs).

Export examples:

```bash
# Export dev.db to a timestamped file under ./exports/ (DB snapshot)
DB_NAME=dev npm run export:db

# Export dev.db as SQL
DB_NAME=dev npm run export:sql

# Export a specific DB by name to a specific path
node scripts/export-db.js --db-name test_ui --out ./exports/test_ui.db
```

Import examples:

```bash
# Restore a DB snapshot into dev.db (requires --yes). Makes a backup by default.
node scripts/import-db.js --yes --in ./exports/dev-YYYYMMDD-HHMMSS.db --db-name dev

# Import a SQL dump by replacing the target DB file
node scripts/import-db.js --yes --in ./exports/dev-YYYYMMDD-HHMMSS.sql --db-name dev --replace
```

Start server (development)

```bash
npm start
# run with a specific DB
DB_NAME=test_ui PORT=4001 node index.js

# dev mode with auto-reload
npm run dev
```

HTTPS (required for iPhone live camera)
-------------------------------

iOS Safari blocks `getUserMedia` camera access on `http://` origins (except `http://localhost`).
If you open the UI on your phone using `http://<LAN-IP>:4001/ui/`, live camera scanning will not work.

Recommended (easiest): use a tunnel with a trusted HTTPS URL

```bash
# Example: ngrok
ngrok http 4001
# Open the printed https://.../ui/ URL on your iPhone
```

Helper script (trusted HTTPS tunnel)
----------------------------------

If you don't want to install certificates on the iPhone, use the tunnel helper:

```bash
./scripts/start-https-tunnel.sh --port 4001
# optionally pick a DB:
./scripts/start-https-tunnel.sh --port 4001 --db test_ui
```

It will start the server (if needed) and run an HTTPS tunnel via `ngrok` (preferred) or `cloudflared`.

Optional (server runs HTTPS directly): provide your own cert/key

```bash
SSL_KEY_PATH=/path/to/key.pem SSL_CERT_PATH=/path/to/cert.pem PORT=4001 node index.js
```

Note: for iPhone this cert must be trusted by the device (a real cert or a locally trusted CA).

Helper script (mkcert + start HTTPS)
----------------------------------

If you use macOS, the fastest repeatable setup is the helper script:

```bash
./scripts/start-https-dev.sh --port 4001
# optionally pick a DB:
./scripts/start-https-dev.sh --port 4001 --db test_ui
```

This uses `mkcert` to generate a dev cert in `.ssl/` and starts the server with `SSL_CERT_PATH`/`SSL_KEY_PATH`.
For iPhone, you typically must install and trust the mkcert root CA on the device (see script header comments).

Start production-like server (example)

```bash
DB_NAME=prod PORT=4011 NODE_ENV=production npm run start
# or
npm run start:prod
```

Run test suite (uses `test_ui` DB when set)

```bash
# Recommended: keep tests isolated from dev data
DB_NAME=test_ui npm test

# Default (no env): tests run against dev.db
npm test

# run individual UI smoke tests
node tests/ui-suppliers-smoke.js
node tests/ui-smoke.js
```

Export/UX helpers

```bash
# run the sync script to apply migrations across dev/test/prod DBs
./scripts/sync-dbs.sh
```

Notes
-----
- Migrations are idempotent; running them repeatedly is safe.
- For CI, set `DB_NAME=test_ui` and run `npm run migrate` before tests.
- The `scripts/sync-dbs.sh` script runs migrations for `dev`, `test_ui`, and `prod` DB files in this folder.
	Use caution: it will migrate the local `prod.db` file too.

Useful admin / debug commands
-----------------------------
Quick commands used during development and debugging; copy/paste as needed.

```bash
# Note: if you started the dev server via manage-servers, it's usually on port 4002.
# If you used `npm start` directly, it's usually on port 4001.

# Check service health (adjust port as needed)
curl -sS http://localhost:4002/ || curl -sS http://localhost:4011/

# Dump a small sample of QBIDs and extract the first qbid
curl -s http://localhost:4002/api/qbids | head -c 10000 > /tmp/qbids.json
cat /tmp/qbids.json | grep -o '"qbid":"[^"]*"' | head -n 1 | sed 's/"qbid":"\([^"]*\)"/\1/' > /tmp/first_qbid.txt
FIRST_QBID=$(cat /tmp/first_qbid.txt)
echo "First QBID: $FIRST_QBID"

# Example: set stone_type via admin endpoint (replace $FIRST_QBID)
curl -s -X POST http://localhost:4002/admin/set-stone-type -H 'Content-Type: application/json' -d '{"qbid":"'$FIRST_QBID'","stone_type":"granite"}' | jq || true

# Fetch the QBID details
curl -s http://localhost:4002/qbids/$FIRST_QBID | jq || true

# Start server with specific DB and port
DB_NAME=test_ui PORT=4001 node index.js

# Run full test suite (uses test DB)
DB_NAME=test_ui npm test

# Check running node processes and listening ports (macOS)
ps aux | grep node
lsof -iTCP -sTCP:LISTEN -P -n | grep node
```


Managing servers (start/stop/restart)
------------------------------------
A small helper is available in both Bash and Python to manage dev/test/prod instances of the service.

- Bash helper: `scripts/manage-servers.sh`
- Python helper (Click CLI): `scripts/manage-servers.py`

Both helpers behave similarly: they write a PID file to `/tmp/inventory-service-<env>.pid`, a log to `/tmp/inventory-service-<env>.log`, and a persisted port file `/tmp/inventory-service-<env>.port` when an override port is supplied.

Important: the `dev` environment now defaults to port `4002` (previously 4001). Passing `--port` (Python) or a numeric port (Bash) will persist that port for the environment.

Usage examples (Bash):

```bash
# Start the test server (DB=test_ui, default port 4001)
./scripts/manage-servers.sh start test

# Stop the prod server (DB=prod, default port 4011)
./scripts/manage-servers.sh stop prod

# Restart dev on a custom port (also makes 4002 the saved default)
./scripts/manage-servers.sh restart dev 4002

# Check status
./scripts/manage-servers.sh status test
```

Usage examples (Python CLI):

```bash
# Start dev (uses saved/default port, dev default is 4002)
./scripts/manage-servers.py start dev

# Start dev on 4002 and save it as the default for dev
./scripts/manage-servers.py start dev --port 4002

# Restart prod
./scripts/manage-servers.py restart prod

# Status for test
./scripts/manage-servers.py status test
```

Notes:
- The helpers attempt a clean shutdown by reading the PID file and sending SIGTERM, falling back to SIGKILL if the process doesn't stop.
- If the PID file is missing, the helpers will attempt to find and kill processes listening on the configured port as a fallback.
- Logs, PID and port files are placed under `/tmp` so they do not clutter the repo.

